repository: &repository
  repo: "/srv/docker-restic/backup/repository"
  password-file: "/run/secrets/restic-password"

commands:
  init:
    command: ["restic", "init"]
    options:
      <<: *repository

  backup:
    command: ["restic", "backup", "/source"]
    options:
      <<: *repository

  backup-prune:
    command: ["restic", "forget"]
    options:
      <<: *repository
      keep-daily: 7
      keep-weekly: 4
      keep-monthly: 12
      keep-yearly: 2
      group-by: "paths"
      prune: true

  backup-check:
    command: ["restic", "check"]
    options:
      <<: *repository
      read-data: true

  sync:
    command:
      [
        "rclone",
        "sync",
        "/srv/docker-restic/backup/repository",
        "b2:docker-restic-bucket",
      ]
    options:
      stats: "15m"
      fast-list: true
      progress: true

  sync-check:
    command:
      [
        "rclone",
        "check",
        "/srv/docker-restic/backup/repository",
        "b2:docker-restic-bucket",
      ]
    options:
      fast-list: true

  dump:
    command:
      [
        "/bin/sh",
        "-c",
        "restic dump latest / > /srv/docker-restic/backup/export/backup_$(date +'%Y-%m-%d_%H.%M.%S').tar",
      ]
    options:
      <<: *repository
    hooks:
      pre: |
        mkdir -p /srv/docker-restic/backup/export

  dump-prune:
    command:
      [
        "/bin/sh",
        "-c",
        "rm -rf $(ls -t /srv/docker-restic/backup/export/backup_* | tail +5) | xargs -r echo",
      ]

  dump-check:
    command:
      [
        "/bin/sh",
        "-c",
        "echo $(ls -t /srv/docker-restic/backup/export/backup_* | head -1) | xargs -r tar -tf > /dev/null",
      ]

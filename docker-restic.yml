repository: &repository
  repo: "/srv/docker-restic/backup/repository"
  password-file: "/run/secrets/restic-password"

commands:
  init:
    command: ["restic", "init"]
    options:
      <<: *repository

  backup:
    command: ["restic", "backup", "/source"]
    options:
      <<: *repository
    hooks:
      success:
        - forget
        - check

  forget:
    command: ["restic", "forget"]
    options:
      <<: *repository
      keep-daily: 7
      keep-weekly: 4
      keep-monthly: 12
      keep-yearly: 2
      group-by: "paths"
      prune: true

  check:
    command: ["restic", "check"]
    options:
      <<: *repository
      read-data: true

  sync:
    command:
      [
        "rclone",
        "sync",
        "/srv/docker-restic/backup/repository",
        "b2:docker-restic-bucket",
      ]
    options:
      stats: "15m"
      fast-list: true
      progress: true
    hooks:
      success:
        - sync-check

  sync-check:
    command:
      [
        "rclone",
        "check",
        "/srv/docker-restic/backup/repository",
        "b2:docker-restic-bucket",
      ]
    options:
      fast-list: true

  dump:
    command:
      [
        "/bin/sh",
        "-c",
        "restic ${@} dump latest / > /srv/docker-restic/backup/export/backup_$(date +'%Y-%m-%d_%H.%M.%S').tar",
        "--",
      ]
    options:
      <<: *repository
    hooks:
      success:
        - dump-prune
        - dump-check

  dump-prune:
    command:
      [
        "/bin/sh",
        "-c",
        "ls -t /srv/docker-restic/backup/export/backup_* | tail +7 | xargs -r -I {} rm -rf {}",
      ]

  dump-check:
    command:
      [
        "/bin/sh",
        "-c",
        "ls -t /srv/docker-restic/backup/export/backup_* | head -1 | xargs -r -I {} tar -tf {} > /dev/null",
      ]
